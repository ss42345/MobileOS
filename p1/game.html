<!DOCTYPE html>
<html>
<head>

    <style>

        #divMessage1 {
            border:0px solid blue;
            position:absolute;
            background-color:#ffffe0;
        }

        #divMessage2 {
            border:0px solid blue;
            position:absolute;
            background-color:#ffffe0;
        }

        #divHighScores {
            border:0px solid blue;
            position:absolute;
            background-color:#ffffe0;
        }

        #divRecalibrate {
            border:0px solid blue;
            position:absolute;
            background-color:#ffffe0;
        }

        #divPause {
            border:0px solid blue;
            position:absolute;
            background-color:#ffffe0;
        }

        #divTime {
            border:0px solid blue;
            position:absolute;
            background-color:#ffffe0;
        }

        #divScore {
            border:0px solid blue;
            position:absolute;
            background-color:#ffffe0;
        }


        #divBoard {
            border:1px solid blue;
            position:absolute;
            left:0px;
            background:url(stone.jpeg);
        }
        #divBall {
            background:url(goldball.png);
            background-size:contain;
            border:0px solid black;
            box-shadow: 3px 3px 3px black;
            top:200px;
            left:50px;
            position:absolute;
        }
        .divObsWood {
            background:url(wood.jpeg);
            position:absolute;
            box-shadow: 5px 5px 5px black;
        }

    </style>
    <!------ Java Script ------>
    <script>

        //-------------------------------------------------------------
        // Define global variables
        var WinWidth, WinHeight;
        var Game = new Object;
        Game.NumObstacles = 6;
        Game.NumXSections = 3;

        // Game levels
        Game.NumLevels = 3;
        Game.Level = 2; //0, 1 or 2
        Game.NumWoods = [4, 5, 6];
        Game.NumFires = [3, 4, 5];
        Game.NumGolds = [1, 2, 3];

        var DTOR = Math.PI/180;

        // Board layout related variables
        var DiaPct = 4;
        var BoardTopPct = 5;
        var BoardCols = [[0,20],[25,45],[55,75],[80,100]];
        var BoardRows = [[5,25],[30,50],[55,75],[80,100]];
        var Filled = new Array(4);
        for (var i=0; i < 4; i++) {
            Filled[i] = new Array(4);
        }

        //-------------------------------------------------------------
        function StartUp() {

            // Add event listeners
            AddEventListeners();

            // Initialize the game
            InitializeGame();

            // Setup the game board
            SetupGameBoard();
        }

        //-------------------------------------------------------------
        function AddEventListeners() {

            // Motion and orientation events
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', HandleOrientation, false);
            } else {
                message3("Device orientation not supported on this device")
            }

        }

        //-------------------------------------------------------------
        function InitializeGame() {

            // Get window size
            WinWidth = window.innerWidth
                            || document.documentElement.clientWidth
                            || document.body.clientWidth;

            WinHeight = window.innerHeight
                            || document.documentElement.clientHeight
                            || document.body.clientHeight;

            // Board
            var divBoard = document.getElementById('divBoard');
            divBoard.style.width = WinWidth+'px';
            divBoard.style.height = Math.round(WinHeight*(1-BoardTopPct/100))+'px';
            divBoard.style.top = Math.round(WinHeight*BoardTopPct/100)+'px';
            Game.Board = new Rectangle(divBoard.offsetTop, divBoard.offsetLeft,
                                       divBoard.clientWidth, divBoard.clientHeight);

            // Setup Menu
            SetupMenu();

            // Ball
            var divBall = document.getElementById('divBall');
            divBall.style.width = Math.round(WinHeight*DiaPct/100)+'px';
            divBall.style.height = divBall.style.width;
            divBall.style.borderRadius = Math.round(WinHeight*DiaPct/100/2)+'px';
            Game.Ball = new Rectangle(divBall.offsetTop, divBall.offsetLeft,
                                      divBall.clientWidth, divBall.clientHeight);
            Game.Ball.Dia = divBall.clientWidth;

            // Obstacles
            Game.Obstacles = new Array(Game.NumObstacles);

            // Wood, fire and gold obstacles
            Game.Wood = new Array(Game.NumLevels);
            Game.Fire = new Array(Game.NumLevels);
            Game.Gold = new Array(Game.NumLevels);
            for (var l = 0; l < Game.NumLevels; l++) {
                Game.Wood[l] = new Array(Game.NumWoods[l]);
                Game.Fire[l] = new Array(Game.NumFires[l]);
                Game.Gold[l] = new Array(Game.NumGolds[l]);
            }

            // Reset the Filled array
            for (var i=0; i < 4; i++) {
                for (var j=0; j < 4; j++) {
                    Filled[i][j]=0;
                }
            }

                // Setup DxMax and DyMax - same as ball dia
            Game.DxMax = Game.Ball.Dia;
            Game.DyMax = Game.Ball.Dia;
        }

        // Setup Menu
        //-------------------------------------------------------------
        function SetupMenu() {
            var x1=0.0, x2=0.25, x3=0.5, x4=0.6, x5=0.7, x6=0.8, x7=0.9, x8=1.0;
            var menuHeight = Math.round(WinHeight*BoardTopPct/100);

            // Message 1
            var divMessage1 = document.getElementById('divMessage1');
            divMessage1.style.top = '0px';
            divMessage1.style.left = '0px';
            divMessage1.style.width = Math.round(WinWidth*(x2-x1))+'px';
            divMessage1.style.height = menuHeight+'px';
            divMessage1.innerHTML = 'Welcome John';

            // Message 2
            var divMessage2 = document.getElementById('divMessage2');
            divMessage2.style.top = '0px';
            divMessage2.style.left = Math.round(WinWidth*x2)+'px';
            divMessage2.style.width = Math.round(WinWidth*(x3-x2))+'px';
            divMessage2.style.height = menuHeight+'px';
            divMessage2.innerHTML = 'Ball 1 of 3';

            // High Scores
            var divHighScores = document.getElementById('divHighScores');
            divHighScores.style.top = '0px';
            divHighScores.style.left = Math.round(WinWidth*x3)+'px';
            divHighScores.style.width = Math.round(WinWidth*(x4-x3))+'px';
            divHighScores.style.height = menuHeight+'px';

            // Recalibrate
            var divRecalibrate = document.getElementById('divRecalibrate');
            divRecalibrate.style.top = '0px';
            divRecalibrate.style.left = Math.round(WinWidth*x4)+'px';
            divRecalibrate.style.width = Math.round(WinWidth*(x5-x4))+'px';
            divRecalibrate.style.height = menuHeight+'px';

            // Pause
            var divPause = document.getElementById('divPause');
            divPause.style.top = '0px';
            divPause.style.left = Math.round(WinWidth*x5)+'px';
            divPause.style.width = Math.round(WinWidth*(x6-x5))+'px';
            divPause.style.height = menuHeight+'px';

            // Time
            var divTime = document.getElementById('divTime');
            divTime.style.top = '0px';
            divTime.style.left = Math.round(WinWidth*x6)+'px';
            divTime.style.width = Math.round(WinWidth*(x7-x6))+'px';
            divTime.style.height = menuHeight+'px';

            // Score
            var divScore = document.getElementById('divScore');
            divScore.style.top = '0px';
            divScore.style.left = Math.round(WinWidth*x7)+'px';
            divScore.style.width = Math.round(WinWidth*(x8-x7))+'px';
            divScore.style.height = menuHeight+'px';
        }

        //-------------------------------------------------------------
         function SetupGameBoard() {

             // Loop through each level
             for (var l = 0; l < Game.NumLevels; l++) {

                 for (var i = 0; i < Game.NumWoods[l]; i++) {
                     // Loop until an empty spot is found on the board
                     while (1) {
                         var rRow = GetRandom(0,3);
                         var rCol = GetRandom(0,3);
                         if (Filled[rRow][rCol] == 0)
                            break;
                     }

                     // Empty spot found
                     Game.Wood[l][i] = new Object();
                     var xmin = Math.round(BoardCols[rCol][0]*WinWidth/100);
                     var xmax = Math.round(BoardCols[rCol][1]*WinWidth/100);
                     var ymin = Math.round(BoardRows[rRow][0]*WinHeight/100);
                     var ymax = Math.round(BoardRows[rRow][1]*WinHeight/100);
                     var wmin = Game.Ball.Dia;
                     var wmax = xmax-xmin; //2*wmin; // or xmax-xmin
                     var hmin = 2*Game.Ball.Dia;
                     var hmax = ymax-ymin;

                     var woodObj = new Object();
                     PlaceObstacle(woodObj, xmin, xmax, ymin, ymax, wmin, wmax, hmin, hmax);
                     Game.Wood[l][i] = woodObj;
                     Filled[rRow][rCol]=1;
                 }


                 // Fire obstacles

                 // Gold obstacles
             }

             //
             // Draw the obstacles based on the current game level
             //

             // Get the current level
             var level = Game.Level;

             // Create the divs for the wood obstacles
             var woodStr = "";
             for (var i = 0; i < Game.NumWoods[level]; i++) {
                 // Divs for the wood obstacles
                 var woodid = 'wood_'+ i.toString();
                 woodStr += "<div class='divObsWood' id='"+woodid+"'></div><br>"
             }
             document.getElementById('divWoodObstacles').innerHTML = woodStr;

             var wooddivarray = document.getElementsByClassName('divObsWood');

             // Draw the wood obstacles based on the current level
             for (var i = 0; i < Game.NumWoods[level]; i++) {

                 wooddivarray[i].style.left   = Game.Wood[level][i].Left+'px';
                 wooddivarray[i].style.top    = Game.Wood[level][i].Top+'px';
                 wooddivarray[i].style.width  = Game.Wood[level][i].Width+'px';
                 wooddivarray[i].style.height = Game.Wood[level][i].Height+'px';
             }

         }


        //-------------------------------------------------------------
        /****** Old *************
        function SetupGameBoard() {

            // Multiple obstacles
            var numObstacles = Game.NumObstacles;
            var numXSects = Game.NumXSections;
            var numYSects = Math.round(numObstacles/numXSects);
            var boardDeltaX = Game.Board.Width/numXSects;
            var boardDeltaY = Game.Board.Height/numYSects;

            // Create the divs for the obstacles
            var obsStr = "";
            for (var i=0; i < numObstacles; i++) {
                var obsid = 'obstacle_'+ i.toString();
                obsStr += "<div class='obstacles' id='"+obsid+"'></div><br>"
            }
            document.getElementById('divObstacles').innerHTML = obsStr;

            // Set the obstacle locations
            obsdivarray = document.getElementsByClassName('obstacles');
            for (var i=0; i < obsdivarray.length; i++) {

                // Initialize the dimensions
                var obsObj = new Object();
                Game.Obstacles[i] = obsObj;

                var xoff = Game.Board.Left;
                var yoff = Game.Board.Top;
                var bdx = boardDeltaX;
                var bdy = boardDeltaY;
                var ii = i%numXSects;
                var jj = Math.round((i/numXSects)-0.5)%numYSects;
                console.log(ii,jj)

                PlaceObstacle(obsObj, xoff+bdx*ii, xoff+bdx*(ii+1), yoff+bdy*jj, yoff+bdy*(jj+1), bdx/4, bdx, bdy/4, bdy);

                // Draw the obstacles
                obsdivarray[i].style.left   = obsObj.Left+'px';
                obsdivarray[i].style.top    = obsObj.Top+'px';
                obsdivarray[i].style.width  = obsObj.Width+'px';
                obsdivarray[i].style.height = obsObj.Height+'px';
            }

        }

         // This function places the obstacle randomly
         //-------------------------------------------------------------
         function PlaceObstacle(objObstacle, xmin, xmax, ymin, ymax, wmin, wmax, hmin, hmax) {
            // Type of object:
            // 1 => wooden obstacle, 2 => fire obstacle, 3 => gold coin
            objObstacle.Type = GetRandom(1,3);
            objObstacle.Width = GetRandom(wmin, wmax);
            objObstacle.Height = GetRandom(hmin, hmax);
            objObstacle.Left = GetRandom(xmin, xmax-objObstacle.Width);
            objObstacle.Top = GetRandom(ymin, ymax-objObstacle.Height);
            console.log(objObstacle)
        }

         ******************/

        // Event handler
        //-------------------------------------------------------------
        function HandleOrientation(event) {

            // Initialize local variables
            var level    = Game.Level;
            var xCurrent = Game.Ball.Left;
            var yCurrent = Game.Ball.Top;
            var dia = Game.Ball.Dia;
            var divBall = document.getElementById('divBall');

            // Read the orientation angles
            var roll = (-event.gamma)*DTOR; // -90 to +90
            var pitch = (event.beta)*DTOR; // -180 to +180

            // Compute the new position
            var xplier = 300;
            var dx = pitch*xplier;
            var dy = roll*xplier;
            if (dx > Game.DxMax) dx = Game.DxMax;
            if (dy > Game.DyMax) dy = Game.DyMax;
            var xNew = xCurrent + Math.round(dx);
            var yNew = yCurrent + Math.round(dy);

            // Check if the new position is inside the board and make adjustments if necessary
            var collision1 = CheckCollisionInside(xNew, yNew, Game.Board.Left, Game.Board.Top, Game.Board.Width-dia, Game.Board.Height-dia);
            xNew = collision1.x;
            yNew = collision1.y;

            // Check for collisions with any of the obstacles
            var collision = false;
            var collisionData = new Array();
            var numCollisions = 0, idxCollision = 0;
            for (var i = 0; i < Game.NumWoods[level]; i++) {
                collisionData[i] = CheckCollisionOutside(xNew, yNew, xCurrent, yCurrent,
                                                    Game.Wood[level][i].Left-dia, Game.Wood[level][i].Top-dia,
                                                    Game.Wood[level][i].Width+dia, Game.Wood[level][i].Height+dia);

                if (collisionData[i].collision) {
                    numCollisions = numCollisions+1;
                    idxCollision = i;
                }
            }

            var drawBall = false;
            if (numCollisions == 0) {
                drawBall = true;
                //divBall.style.backgroundColor = 'blue';
            }
            else if (numCollisions == 1) {
                var drawBall = true;
                var xNew = collisionData[idxCollision].x;
                var yNew = collisionData[idxCollision].y;
                //divBall.style.backgroundColor = 'red';
            }

            if (drawBall) {
                divBall.style.left = xNew+'px';
                divBall.style.top = yNew+'px';

                // Update the Game.Ball object
                Game.Ball.Left = xNew;
                Game.Ball.Top = yNew;
            }
        }

        //-------------------------------------------------------------
        // Utility functions
        //-------------------------------------------------------------

        // This function places the obstacle randomly
        //-------------------------------------------------------------
        function Rectangle(top,left,width,height)
        {
            this.Top    = top;
            this.Left   = left;
            this.Width  = width;
            this.Height = height;
        }

        // This function places the obstacle randomly
        //-------------------------------------------------------------
        function PlaceObstacle(objObstacle, xmin, xmax, ymin, ymax, wmin, wmax, hmin, hmax) {
            objObstacle.Width   = GetRandom(wmin, wmax);
            objObstacle.Height  = GetRandom(hmin, hmax);
            objObstacle.Left    = GetRandom(xmin, xmax-objObstacle.Width);
            objObstacle.Top     = GetRandom(ymin, ymax-objObstacle.Height);
            console.log(objObstacle)
        }

        // This function returns a random number in the specified range
        //-------------------------------------------------------------
        function GetRandom(min, max) {
            var num = Math.round(min + Math.random()*(max-min));
            return num;
        }

        // This function checks if the point (x,y) is inside the rectangle
        //--------------------------------------------------------------------
        function IsInside(x, y, left, top, width, height) {
            if (x > left && x < (left+width) && y > top && y < (top+height))
                return true;
            else
                return false;
        }

        function CheckCollisionInside(x, y, left, top, width, height) {
            var right = left+width;
            var bottom = top+height;

            if (x > right) x = right;
            if (x < left) x = left;
            if (y > bottom) y = bottom;
            if (y < top) y = top;
            return {'x':x, 'y':y};
        }

        function CheckCollisionOutside(x, y, xold, yold, left, top, width, height) {
            var right = left+width;
            var bottom = top+height;
            var collision = false;

            if ((x >= left && x <= right) && (y >= top && y <= bottom))
            {
                // Collision detected
                collision = true;

                if (xold <= left) {
                    x = left;
                }
                if (xold >= right) {
                    x = right;
                }
                if (yold <= top) {
                    y = top;
                }
                if (yold >= bottom) {
                    y = bottom;
                }
            }
            return {'collision':collision,  'x':x, 'y':y};
        }

    </script>
    </head>
    <body onload="StartUp()">

        <div id="divBoard"></div>
        <div id="divWoodObstacles"></div>
        <div id="divFireObstacles"></div>
        <div id="divGoldObstacles"></div>
        <div id="divBall"></div>
        <div id="divMessage1"></div>
        <div id="divMessage2"></div>
        <button type="button" id="divHighScores">High Scores</button>
        <button type="button" id="divRecalibrate">Recalibrate</button>
        <button type="button" id="divPause">Pause</button>
        <div id="divTime">Time Taken</div>
        <div id="divScore">Your Score</div>

        <div id="debugDiv1"></div><br>
        <div id="debugDiv2"></div>
        <div id="debugDiv3"></div>
        <div id="debugDiv4"></div>
        <div id="debugDiv5"></div>
        <div id="debugDiv6"></div>
    </body>
</html>